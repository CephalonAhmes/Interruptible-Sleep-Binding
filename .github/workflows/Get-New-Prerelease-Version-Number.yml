on:
  workflow_call:
    outputs:
      new_version: 
        description: "Final returned version number"
        value: ${{ jobs.Get-New-Prerelease-Version-Number.outputs.new_version }}

jobs:
  Get-New-Prerelease-Version-Number:
    name: Get-New-Version-Number
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.select-final-version-output.outputs.new_version  }}
    steps:
      - uses: actions/checkout@v2
      - id: get-latest-tag
        shell: pwsh
        env:
          pull_request_id: ${{github.event.pull_request.number}}
        run: |
          git fetch --all --tags
          $tags = git tag -l
          $latest_tag = $tags | where-object{ $_ -match "b0\.$($Env:pull_request_id).*" } | select -Last 1
          if($latest_tag){
            echo "::set-output name=latest_tag::$($latest_tag.substring(1))"
          }

      - uses: actions-ecosystem/action-bump-semver@v1
        id: bump-semver
        if: ${{ steps.get-latest-tag.outputs.latest_tag }}
        with:
          current_version: ${{ steps.get-latest-tag.outputs.latest_tag }}
          level: patch
      
      - name: select-final-version-output
        id: select-final-version-output
        shell: pwsh
        env:
          pull_request_id: ${{github.event.pull_request.number}}
          latest_tag: ${{ steps.get-latest-tag.outputs.latest_tag }}
          new_version: ${{ steps.bump-semver.outputs.new_version  }}
        run: |
          if($Env:latest_tag){
            echo "::set-output name=new_version::$($Env:new_version)"
          }
          else{
            echo "::set-output name=new_version::0.$($Env:pull_request_id).0"
          }